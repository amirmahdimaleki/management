# صفحه اصلی پروژه: مدیریت پروفایل کاربری

> **آخرین به‌روزرسانی:** ۱۷/۰۶/۱۴۰۴
> **نویسنده:** امیرمهدی ملکی
> **وضعیت:** پروژه آزمایشی

## فهرست مطالب (Table of Contents)

1.  [معرفی پروژه](#1-معرفی-پروژه)
2.  [لینک‌های مهم](#2-لینکهای-مهم)
3.  [گزارش و لاگ ۲۰ روزه توسعه](#3-گزارش-و-لاگ-۲۰-روزه-توسعه)

---

## 1. معرفی پروژه

این پروژه یک سیستم کامل فول‌استک برای مدیریت پروفایل و اعتبارسنجی کاربران است. هدف اصلی، ایجاد یک زیرساخت امن، مدرن و مقیاس‌پذیر برای مدیریت اطلاعات حساس کاربران مانند ایمیل، شماره موبایل و رمز عبور است. تمامی فرآیندها با در نظر گرفتن بهترین شیوه‌های امنیتی و تجربه کاربری (UX) طراحی شده‌اند.

---

## 2. لینک‌های مهم

- [مستند طراحی فنی - معماری و تصمیمات کلیدی](#backend---technical-design---user-profile-system)
- [مستندات API - لیست کامل اندپوینت‌ها](#project---api-documentation---user--auth)
- [راهنمای نحوه اجرا (How-To) - راه‌اندازی پروژه](#project---how-to-guide---setup--run)

---

# Backend - Technical Design - User Profile System

`برچسب‌ها: backend, design, architecture, nodejs, prisma`

> **آخرین به‌روزرسانی:** ۱۶/۰۶/۱۴۰۴
> **نویسنده:** امیرمهدی ملکی
> **وضعیت:** پروژه آزمایشی

### فهرست مطالب

1.  [مقدمه](#1-مقدمه)
2.  [معماری سیستم](#2-معماری-سیستم)
3.  [پشته فناوری (Tech Stack)](#3-پشته-فناوری-tech-stack)
4.  [تصمیمات کلیدی](#4-تصمیمات-کلیدی)

### 1. مقدمه

این مستند به تشریح معماری، پشته فناوری و تصمیمات فنی اتخاذ شده برای توسعه بخش بک‌اند پروژه مدیریت پروفایل می‌پردازد.

### 2. معماری سیستم

معماری استفاده شده یک **معماری ماژولار (Modular Architecture)** بر پایه فریم‌ورک Express.js است. منطق برنامه به بخش‌های کوچکتر و مستقل تقسیم شده است:

- **`Routes`**: مسئولیت تعریف اندپوینت‌های HTTP و اتصال آن‌ها به کنترلرها را بر عهده دارد.
- **`Controllers`**: لایه‌ی ارتباطی بین درخواست‌های HTTP و منطق اصلی برنامه.
- **`Services`**: قلب منطق تجاری (Business Logic) برنامه در این لایه قرار دارد.
- **`Middlewares`**: قطعه کدهایی که قبل از رسیدن درخواست به کنترلر اجرا می‌شوند (احراز هویت، اعتبارسنجی، و غیره).

#### دیاگرام جریان داده (Data Flow Diagram)

[User Request] --> [Router] --> [Middleware] --> [Controller] --> [Service] --> [Prisma ORM] --> [PostgreSQL DB]

### 3. پشته فناوری (Tech Stack)

| بخش            | تکنولوژی/کتابخانه                 | دلیل انتخاب                                                            |
| :------------- | :-------------------------------- | :--------------------------------------------------------------------- |
| **فریم‌ورک**   | Node.js + Express.js + TypeScript | اکوسیستم گسترده، سرعت بالا و استفاده از تایپ‌اسکریپت برای پایداری.     |
| **ORM**        | Prisma                            | سینتکس ساده، تولید تایپ‌های امن (Type-Safe) و سیستم Migration قدرتمند. |
| **اعتبارسنجی** | Zod                               | یکپارچگی عالی با تایپ‌اسکریپت و تعریف اسکیمای ولیدیشن به صورت شفاف.    |
| **احراز هویت** | JWT (jsonwebtoken) + Argon2       | JWT برای توکن‌های امن و Argon2 به عنوان الگوریتم هشینگ مدرن و امن.     |
| **دیتابیس**    | PostgreSQL                        | پایداری، قابلیت‌های پیشرفته و پشتیبانی عالی از انواع داده.             |
| **کش و صف**    | Redis                             | مدیریت OTP و Rate Limiting.                                            |
| **لاگ‌گیری**   | Pino                              | عملکرد بسیار سریع و سربار کم برای لاگ‌گیری.                            |
| **محیط توسعه** | Docker                            | ایزوله‌سازی سرویس‌ها (DB, Redis) و یکسان‌سازی محیط توسعه.              |

### 4. تصمیمات کلیدی

- **استفاده از `tsx` به جای `ts-node-dev`**: به دلیل مشکلات مربوط به ماژول‌های ESM، از `tsx` به عنوان یک ابزار مدرن و بدون نیاز به کانفیگ استفاده شد.
- **انتخاب `Argon2` به جای `bcrypt`**: الگوریتم Argon2 در برابر حملات GPU مقاوم‌تر و امن‌تر است.
- **ابطال سراسری نشست‌ها (Session Invalidation)**: با افزودن فیلد `sessionVersion` به مدل User، توانستیم پس از تغییر رمز عبور، تمام توکن‌های قدیمی را بی‌اعتبار کنیم.
- **استفاده از Redis برای OTP**: به جای ذخیره کدهای یکبار مصرف در دیتابیس اصلی، از Redis استفاده شد تا با قابلیت TTL، کدها به طور خودکار پس از انقضا حذف شوند.

---

# Project - Development Log - 20 Days Sprint

`برچسب‌ها: log, development, journal`

> **آخرین به‌روزرسانی:** ۱۷/۰۶/۱۴۰۴
> **نویسنده:** امیرمهدی ملکی
> **وضعیت:** پروژه آزمایشی

### روز 1: راه‌اندازی و زیرساخت

کار با آماده‌سازی محیط توسعه، راه‌اندازی کانتینرهای PostgreSQL و Redis با Docker و ایجاد ساختار اولیه پروژه بک‌اند با Node.js, Express و TypeScript آغاز شد.

### روز 2-3: دیتابیس و احراز هویت پایه

مدل‌های اولیه `User` و `TermsConsent` با Prisma OR طراحی و اولین `migration` روی دیتابیس اجرا شد. سپس منطق ثبت نام و ورود کاربر با JWT و هشینگ Argon2 پیاده‌سازی گردید.

### روز 4-6: ساخت پروژه فرانت‌اند

پروژه فرانت‌اند با Vite و React + TypeScript راه‌اندازی شد. برای استایل‌دهی، نسخه آلفای Tailwind CSS v4 به دلیل قابلیت‌های مدرن آن انتخاب شد.

### روز 6-7: صفحات اصلی و فرم‌ها

صفحات ورود، ثبت نام و پروفایل با استفاده از `React Hook Form` و `Zod` برای مدیریت فرم‌ها و `TanStack Query` برای ارتباط با API طراحی شدند.

### روز 7-8: تکمیل پروفایل و جریان OTP

ویژگی‌های اصلی صفحه پروفایل مانند ویرایش نام و تغییر رمز عبور تکمیل شد. جریان دو مرحله‌ای تغییر ایمیل با OTP با استفاده از Redis در بک‌اند و یک مودال در فرانت‌اند پیاده‌سازی شد.

### روز 8-9: ویژگی‌های امنیتی پیشرفته

دو قابلیت امنیتی مهم اضافه شد: ۱) ابطال نشست‌ها پس از تغییر رمز با استفاده از فیلد `sessionVersion` و ۲) اجبار به پذیرش قوانین جدید در هنگام ورود.

### روز 10: نهایی‌سازی، چالش‌ها و مستندسازی

در روز آخر، تمرکز بر نهایی‌سازی پروژه بود. یک چالش بزرگ، داکرایز کردن کامل پروژه بود. به دلیل **تحریم‌ها و دسترسی ضعیف اینترنت در خوابگاه**، دانلود بیس ایمیج‌های Docker به طور مداوم با خطا مواجه می‌شد. به همین دلیل، داکرایز کردن سرویس‌های جانبی برای توسعه کافی دانسته شد و داکرایز کردن نهایی اپلیکیشن‌ها به زمانی با شبکه پایدارتر موکول گردید. در نهایت، تمام وقت باقی‌مانده صرف نوشتن همین مستندات و تمیزکاری نهایی کدها شد.

---

# Project - API Documentation - User & Auth

`برچسب‌ها: api, documentation, backend, endpoints`

> **آخرین به‌روزرسانی:** ۱۷/۰۶/۱۴۰۴
> **نویسنده:** امیرمهدی ملکی
> **وضعیت:** پروژه آزمایشی

## ماژول احراز هویت (`/api/v1/auth`)

### `POST /register`

- **توضیحات**: ثبت نام کاربر جدید.
- **پارامترها (Body)**: `{ "name": "string", "email": "string", "password": "string" }`
- **پاسخ موفق (201)**: `{ "message": "...", "user": { ... }, "token": "..." }`

### `POST /login`

- **توضیحات**: ورود کاربر.
- **پارامترها (Body)**: `{ "email": "string", "password": "string" }`
- **پاسخ موفق (200)**: `{ "message": "...", "user": { ..., "needsConsent": boolean }, "token": "..." }`

## ماژول کاربر (`/api/v1/users`)

`نکته: تمام این اندپوینت‌ها نیازمند توکن JWT در هدر Authorization هستند.`

### `GET /me`

- **توضیحات**: دریافت اطلاعات پروفایل کاربر لاگین کرده.
- **پاسخ موفق (200)**: `{ "user": { ...userObject } }`

### `PUT /me`

- **توضیحات**: ویرایش اطلاعات عمومی پروفایل.
- **پارامترها (Body)**: `{ "name": "string" }`
- **پاسخ موفق (200)**: `{ "message": "...", "user": { ...userObject } }`

### `POST /me/change-password`

- **توضیحات**: تغییر رمز عبور با بررسی رمز قبلی.
- **پارامترها (Body)**: `{ "oldPassword": "string", "newPassword": "string" }`
- **پاسخ موفق (200)**: `{ "message": "Password changed successfully" }`

### `POST /me/email/change/start`

- **توضیحات**: شروع فرآیند تغییر ایمیل و ارسال OTP.
- **پارامترها (Body)**: `{ "newEmail": "string" }`
- **پاسخ موفق (200)**: `{ "message": "An OTP has been sent..." }`

### `POST /me/email/change/verify`

- **توضیحات**: پروژه OTP و نهایی کردن تغییر ایمیل.
- **پارامترها (Body)**: `{ "otp": "string" }`
- **پاسخ موفق (200)**: `{ "message": "Email address updated successfully." }`

---

# Project - How-To Guide - Setup & Run

`برچسب‌ها: how-to, guide, setup, docker`

> **آخرین به‌روزرسانی:** ۱۷/۰۶/۱۴۰۴
> **نویسنده:** امیرمهدی ملکی
> **وضعیت:** پروژه آزمایشی

## پیش‌نیازها

- **Docker** و **Docker Compose** (برای دیتابیس و Redis)
- **Node.js** (ورژن ۱۸ به بالا)
- **pnpm** (یا npm/yarn)
- **Git**

## مراحل راه‌اندازی

### ۱. راه‌اندازی سرویس‌های جانبی (دیتابیس و Redis)

به دلیل چالش‌های شبکه، در این راهنما فقط سرویس‌های دیتابیس و Redis را با Docker و اپلیکیشن‌ها را به صورت محلی اجرا می‌کنیم.

- یک فایل `.env` در **ریشه پروژه** بسازید و متغیرهای `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` را در آن تعریف کنید.
- دستور زیر را در ریشه پروژه اجرا کنید:
  ```bash
  sudo docker compose up -d postgres_db redis_cache
  ```

### ۲. راه‌اندازی بک‌اند

- به پوشه `backend` بروید.
- فایل `backend/.env.example` را به `backend/.env` کپی کرده و مقادیر آن (به خصوص `DATABASE_URL` با `localhost`) را تکمیل کنید.
- دستورات زیر را اجرا کنید:
  ```bash
  pnpm install
  pnpm prisma migrate dev
  pnpm dev
  ```

### ۳. راه‌اندازی فرانت‌اند

- به پوشه `frontend` بروید.
- دستورات زیر را اجرا کنید:
  ```bash
  pnpm install
  pnpm dev
  ```

### ۴. دسترسی به برنامه

- **فرانت‌اند**: `http://localhost:5173`
- **بک‌اند**: `http://localhost:3000`
